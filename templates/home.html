{% extends "template.html" %}

{% block title %}Viti's Store - Catalog{% endblock %}

{% block rightHeader %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/home.css') }}">
{% endblock %}

{% block content %}
    <!-- Slider -->
    <div class="vs-slider-container">
        <section class="vs-slider">
            <div class="vs-slides">
                {% for slide in slides %}
                    <div class="vs-slide {% if loop.first %}vs-active{% endif %}">
                        <img src="{{ slide.src }}" alt="{{ slide.alt }}">
                    </div>
                {% endfor %}

                <div class="hero-content">
                    <p class="short-text">Discover the latest electronics at unbeatable prices! Browse our wide range of
                        smartphones, laptops, headphones, and accessories.</p>
                    <button class="explore-more-button">
                        Explore All Products
                    </button>
                </div>

                <div class="hero-content-product" id="hero-product">
                    <div class="product-image-container">
                        <img id="hero-image" src="{{ products[0].image_url }}"/>
                    </div>
                    <div class="see-detail">
                        <p>See the Product Details</p>
                        <svg width="25" height="25">
                            <use href="/static/svg/sprite.svg#icon-arrow-right-v2"></use>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Navigation buttons -->
            <button class="vs-prev"></button>
            <button class="vs-next"></button>
        </section>
    </div>

    <!-- Product Cards -->
    <section class="vs-products">
        <div class="vs-container">
            <div class="vs-container-header">
                <h2>DISCOVER</h2>
                <button class="discover-more-button">
                    <span>More Product</span>
                    <svg width="20" height="20">
                        <use href="/static/svg/sprite.svg#icon-arrow-right-v2"></use>
                    </svg>
                </button>
            </div>
            <div class="vs-product-grid">
                {% for product in products %}
                    <div class="vs-product-card">
                        <div class="vs-product-img-wrapper"
                             onclick="location.href='{{ url_for('product', product_id=product.id) }}'">

                            <img src="{{ product.image_url }}" alt="{{ product.name }}">

                        </div>

                        <div class="vs-bottom-card">
                            <h3>{{ product.name }}</h3>
                            <p class="vs-price">${{ "%.2f" | format(product.price) }}</p>
                        </div>

                        <div class="vs-actions">
                            <a class="vs-cart" href="#"
                               data-id="{{ product.id }}"
                               data-name="{{ product.name }}"
                               data-description="{{ product.description }}"
                               data-price="{{ product.price }}"
                               data-image="{{ product.image_url }}">
                                <svg width="18" height="18">
                                    <use href="/static/svg/sprite.svg#icon-shopping-bag"></use>
                                </svg>
                                Add to Cart
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Footer -->
    {% include 'partials/footer.html' %}


    <div id="vs-toast" class="vs-toast"></div>

    <script>
        // Create array of objects: {id, image_url}
        const products = [
            {% for product in products %}
                {id: {{ product.id }}, image_url: "{{ product.image_url }}"}{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        const heroImage = document.getElementById('hero-image');
        const heroCard = document.getElementById('hero-product');
        let currentIndex = 0;

        // Function to show next image
        function showNextImage() {
            heroImage.classList.add('fade-out');

            setTimeout(() => {
                currentIndex = (currentIndex + 1) % products.length;
                heroImage.src = products[currentIndex].image_url;
                heroImage.classList.remove('fade-out');
            }, 500);
        }

        // Change image every 3 seconds
        setInterval(showNextImage, 3000);

        // Click to go to product page
        heroCard.addEventListener('click', () => {
            const productId = products[currentIndex].id;
            window.location.href = "{{ url_for('product', product_id=0) }}".replace('/0', '/' + productId);
        });
    </script>

    <!-- Slider Script -->
    <script>
        const slides = document.querySelectorAll(".vs-slide");
        const prevBtn = document.querySelector(".vs-prev");
        const nextBtn = document.querySelector(".vs-next");

        let index = 0;

        function showSlide(i) {
            slides.forEach((slide, idx) => {
                slide.classList.toggle("vs-active", idx === i);
            });
        }

        function nextSlide() {
            index = (index + 1) % slides.length;
            showSlide(index);
        }

        function prevSlide() {
            index = (index - 1 + slides.length) % slides.length;
            showSlide(index);
        }

        nextBtn.addEventListener("click", nextSlide);
        prevBtn.addEventListener("click", prevSlide);

        // Auto slide every 5s
        setInterval(nextSlide, 5000);
    </script>

    <script>

        // Function to get total cart count
        function updateCartCount() {
            const carts = JSON.parse(localStorage.getItem('carts')) || [];
            const totalCount = carts.length;
            const countElement = document.getElementById('cart-count');
            if (countElement) {
                countElement.textContent = totalCount;
            }
        }

        // Call on page load
        updateCartCount();

        window.addEventListener('storage', updateCartCount);

        function showToast(message) {
            const toast = document.getElementById("vs-toast");
            toast.textContent = message;
            toast.classList.add("show");

            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove("show");
            }, 3000);
        }


        const cartButtons = document.querySelectorAll(".vs-cart");

        cartButtons.forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();

                const product = {
                    id: parseInt(btn.dataset.id),
                    name: btn.dataset.name,
                    description: btn.dataset.description,
                    price: parseFloat(btn.dataset.price),
                    image: btn.dataset.image,
                    quantity: 1 // default quantity
                };

                // Get existing carts
                let carts = JSON.parse(localStorage.getItem("carts")) || [];

                // Check if product already exists
                const existingProduct = carts.find(p => p.id === product.id);
                if (existingProduct) {
                    existingProduct.quantity += 1; // increment quantity
                } else {
                    carts.push(product);
                }

                // Save back to localStorage
                localStorage.setItem("carts", JSON.stringify(carts));

                updateCartCount();

                showToast(`${product.name} added to cart!`);
            });
        });
    </script>

{% endblock %}
