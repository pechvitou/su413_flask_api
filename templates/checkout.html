{% extends "template.html" %}

{% block title %}Boak's Store - Checkout{% endblock %}

{% block rightHeader %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/checkout.css') }}">
{% endblock %}

{% block content %}
    <div class="checkout-container">
        <div class="checkout-sub-container">
            <!-- Left: Order Summary -->
            <div class="checkout-summary">
                <h2>
                    <img width="30" height="30" src="/static/svg/receipt.svg"/>Order Summary</h2>
                <div id="orderSummary" class="order-summary-list"></div>
                <hr style="border: 1px solid #ddd; width: 100%">
                <p class="total">Total USD: $<span id="totalUSD">0.00</span></p>

                <p class="total">Total Riel: KHR<span id="totalRiel">0</span></p>
            </div>

            <!-- Right: User Info Form -->
            <div class="checkout-form">
                <h2>Shipping Information</h2>
                <form id="userForm" method="POST" action="{{ url_for('checkout') }}">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" name="name" required>

                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>

                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required>

                    <label for="address">Shipping Address</label>
                    <textarea id="address" name="address" rows="4" required></textarea>

                    <button type="submit" class="proceed-btn">Proceed</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let carts = JSON.parse(localStorage.getItem('carts')) || [];
            const totalUSDSpan = document.getElementById('totalUSD');
            const totalRielSpan = document.getElementById('totalRiel');
            const EXCHANGE_RATE = 4000;

            function renderOrderSummary() {
                const orderSummaryList = document.getElementById('orderSummary');
                orderSummaryList.innerHTML = '';
                let totalUSD = 0;

                if (carts.length === 0) {
                    orderSummaryList.innerHTML = '<p style="text-align:center; color:#555;">Your cart is empty</p>';
                    totalUSDSpan.textContent = '0.00';
                    totalRielSpan.textContent = '0';
                    return;
                }

                carts.forEach(item => {
                    totalUSD += item.price * item.quantity;
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    summaryItem.innerHTML = `
          <span>${item.name} x${item.quantity}</span>
          <span>$${(item.price * item.quantity).toFixed(2)}</span>
        `;
                    orderSummaryList.appendChild(summaryItem);
                });

                totalUSDSpan.textContent = totalUSD.toFixed(2);
                totalRielSpan.textContent = Math.round(totalUSD * EXCHANGE_RATE);
            }

            renderOrderSummary();

            document.getElementById('userForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const proceedBtn = this.querySelector('.proceed-btn');
                proceedBtn.disabled = true;
                proceedBtn.textContent = 'Processing...';

                const formData = new FormData(this);
                formData.append('cart', JSON.stringify(carts));

                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        localStorage.removeItem('carts');
                        window.location.href = '/invoice';
                    } else {
                        proceedBtn.disabled = false;
                        proceedBtn.textContent = 'Proceed';
                    }
                } catch (err) {
                    console.error(err);
                    proceedBtn.disabled = false;
                    proceedBtn.textContent = 'Proceed';
                }
            });
            // Updted
        });
    </script>
{% endblock %}
